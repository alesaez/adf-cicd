name: CI/CD v2 (Git-based)

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install npm packages
        run: |
          npm install
          npm ci
        working-directory: ./build # replace with the folder that contains package.json

      - name: Validate ADF resources
        run: |
          npm run build validate "${{ github.workspace }}${{ vars.ADF_ROOT_FOLDER }}" ${{ secrets.ADF_RESOURCE_ID }}
        working-directory: ./build # replace as above

      - name: Validate and generate ARM template
        run: |
          npm run build export "${{ github.workspace }}${{ vars.ADF_ROOT_FOLDER }}" ${{ secrets.ADF_RESOURCE_ID }} "ArmTemplate"
        # For preview mode, replace the above line with your preview command (ensure package.json contains it)
        working-directory: ./build

      - name: Commit and push ARM templates to adf_publish branch
        run: |
          # Get first 10 characters of current commit SHA
          COMMIT_SHORT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHORT:0:10}"
          
          # Save ARM templates to a temporary location before switching branches
          cp -r build/ArmTemplate /tmp/ArmTemplate_temp
          
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if adf_publish branch exists remotely
          git fetch origin adf_publish 2>/dev/null || true
          
          # Stash or remove untracked files to avoid conflicts
          git clean -fd
          
          # Create a new orphan branch or checkout existing
          if git show-ref --verify --quiet refs/remotes/origin/adf_publish; then
            git checkout adf_publish
            git pull origin adf_publish
            # Clear the branch
            git rm -rf . 2>/dev/null || true
          else
            git checkout --orphan adf_publish
            git rm -rf . 2>/dev/null || true
          fi
          
          # Copy ARM templates from temporary location to root
          cp -r /tmp/ArmTemplate_temp/* .
          rm -rf /tmp/ArmTemplate_temp
          
          # Add all changes
          git add -A
          
          # Commit with short SHA
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Published ARM templates from commit ${COMMIT_SHORT}"
            git push origin adf_publish
          fi
          
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout adf_publish branch
        uses: actions/checkout@v4
        with:
          ref: adf_publish

      - uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ vars.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ vars.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}"}'
      
      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Generate GitHub temporary token for raw file access
        id: generate_token
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate a fine-grained token with 1 hour expiration using gh CLI
          # The token will have read access to repository contents
          gh auth token

          TEMP_TOKEN=$(gh auth token)
          echo "GITHUB_RAW_TOKEN=${TEMP_TOKEN}" >> "$GITHUB_ENV"
          
          # Construct the base URI for raw files
          # Format: https://raw.githubusercontent.com/owner/repo/refs/heads/branch/path
          CONTAINER_URI="https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/adf_publish"
          echo "GITHUB_CONTAINER_URI=${CONTAINER_URI}" >> "$GITHUB_ENV"
          
          echo "Container URI: ${CONTAINER_URI}"
          echo "Note: Generated temporary token valid for 1 hour"
          
      # TODO: Add PrePostDeployment script steps here if needed

      - name: List Override Params
        shell: pwsh
        run: |
          $paramPath = "./linkedTemplates/ArmTemplateParameters_master.json"
          
          $parameters = (Get-Content $paramPath | ConvertFrom-Json).parameters | ConvertTo-Json
          $params = (ConvertFrom-Json $parameters).psobject.properties  

          $paramStr=""
          foreach ($name in $params.name) {
              $paramStr+= $name + "=`"" + $params[$name].value.value + "`" "
          }

          Write-Host ("#"*100)
          Write-Host ("#"*15)"Override Parameters "("#"*15)
          Write-Host ("#"*100)
          Write-Host ""
          Write-Host $paramStr
          Write-Host ""
          Write-Host ("#"*100)
          
    #   - name: Deploy ARM template (Linked) to Resource Group
    #     uses: azure/arm-deploy@v2
    #     with:
    #       deploymentName: "adf-deployment-${{ github.run_id }}"
    #       resourceGroupName: ${{ vars.ADF_RESOURCE_GROUP }}
    #       template: ./linkedTemplates/ArmTemplate_master.json
    #       parameters: ./linkedTemplates/ArmTemplateParameters_master.json factoryName="${{ vars.ADF_NAME }}" AzureDataLakeStorage_properties_typeProperties_url="https://stasanprd.dfs.core.windows.net/" AzureSqlDatabase_properties_typeProperties_server="asa-nprd-sql.database.windows.net" AzureSqlDatabase_properties_typeProperties_database="AdventureWorksDB" containerUri="${{ env.GITHUB_CONTAINER_URI }}/linkedTemplates" containerSasToken="?token=${{ env.GITHUB_RAW_TOKEN }}"
    #       deploymentMode: Incremental
    #       # additionalArguments: "--what-if --rollback-on-error" # --what-if-exclude-change-types Create Ignore"

      - name: Deploy ARM template with AZ CLI
        run: |

          cd ./linkedTemplates
          az deployment group create --name "adf-deployment-${{ github.run_id }}" --resource-group ${{ vars.ADF_RESOURCE_GROUP }} --template-file ArmTemplate_master.json --parameters @ArmTemplateParameters_master.json --parameters containerUri="${{ env.GITHUB_CONTAINER_URI }}/linkedTemplates" containerSasToken="?token=${{ env.GITHUB_RAW_TOKEN }}"
