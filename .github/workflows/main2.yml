name: CI/CD v2 (Git-based)

on:
  push:
    branches: [ main ]

env: 
    branch: 'adf_publish'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install npm packages
        run: |
          npm install
          npm ci
        working-directory: ./build # replace with the folder that contains package.json

      - name: Validate ADF resources
        run: |
          npm run build validate "${{ github.workspace }}${{ vars.ADF_ROOT_FOLDER }}" ${{ secrets.ADF_RESOURCE_ID }}
        working-directory: ./build # replace as above

      - name: Validate and generate ARM template
        run: |
          npm run build export "${{ github.workspace }}${{ vars.ADF_ROOT_FOLDER }}" ${{ secrets.ADF_RESOURCE_ID }} "ArmTemplate"
        # For preview mode, replace the above line with your preview command (ensure package.json contains it)
        working-directory: ./build

      - name: Commit and push ARM templates to publish branch
        run: |
          # Get first 10 characters of current commit SHA
          COMMIT_SHORT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHORT:0:10}"
          
          # Save ARM templates to a temporary location before switching branches
          cp -r build/ArmTemplate /tmp/ArmTemplate_temp
          
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if publish branch exists remotely
          git fetch origin ${{ env.branch }} 2>/dev/null || true
          
          # Stash or remove untracked files to avoid conflicts
          git clean -fd
          
          # Create a new orphan branch or checkout existing
          if git show-ref --verify --quiet refs/remotes/origin/${{ env.branch }}; then
            git checkout ${{ env.branch }}
            git pull origin ${{ env.branch }}
            # Clear the branch
            git rm -rf . 2>/dev/null || true
          else
            git checkout --orphan ${{ env.branch }}
            git rm -rf . 2>/dev/null || true
          fi
          
          # Copy ARM templates from temporary location to root
          cp -r /tmp/ArmTemplate_temp/* .
          rm -rf /tmp/ArmTemplate_temp
          
          # Add all changes
          git add -A
          
          # Commit with short SHA
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Published ARM templates from commit ${COMMIT_SHORT}"
            git push origin ${{ env.branch }}
          fi
          
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout publish branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.branch }}

      - uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ vars.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ vars.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}"}'
      
      - name: Set Container URI
        id: container_uri
        run: |
          # Using Logic App endpoint to serve a GitHub Proxy to retrieve ARM template content. These are the parameters:
          # repo: Owner and repository name. Ex. alesaez/adf-cicd
          # branch: Publish branch. Ex. adf-publish
          # file: file name (include folder path if any). Ex. linkedTemplates/ArmTemplate_master.json (do not include leading slash)
          # token: GitHub Token will be use to authenticate as it has a preset expiration.
    
          CONTAINER_URI="${{ secrets.AZURE_LOGIC_APP_ENDPOINT }}&owner=${{ github.repository_owner }}&repo=${{ github.event.repository.name }}&branch=${{ env.branch }}&file="
          echo "GITHUB_CONTAINER_URI=${CONTAINER_URI}" >> "$GITHUB_ENV"
          
      # TODO: Add PrePostDeployment script steps here if needed

      - name: List Override Params
        shell: pwsh
        run: |
          $paramPath = "./linkedTemplates/ArmTemplateParameters_master.json"
          
          $parameters = (Get-Content $paramPath | ConvertFrom-Json).parameters | ConvertTo-Json
          $params = (ConvertFrom-Json $parameters).psobject.properties  

          $paramStr=""
          foreach ($name in $params.name) {
              $paramStr+= $name + "=`"" + $params[$name].value.value + "`" "
          }

          Write-Host ("#"*100)
          Write-Host ("#"*15)"Override Parameters "("#"*15)
          Write-Host ("#"*100)
          Write-Host ""
          Write-Host $paramStr
          Write-Host ""
          Write-Host ("#"*100)
          
    #   - name: Deploy ARM template (Linked) to Resource Group
    #     uses: azure/arm-deploy@v2
    #     with:
    #       deploymentName: "adf-deployment-${{ github.run_id }}"
    #       resourceGroupName: ${{ vars.ADF_RESOURCE_GROUP }}
    #       template: ./linkedTemplates/ArmTemplate_master.json
    #       parameters: ./linkedTemplates/ArmTemplateParameters_master.json factoryName="${{ vars.ADF_NAME }}" AzureDataLakeStorage_properties_typeProperties_url="https://stasanprd.dfs.core.windows.net/" AzureSqlDatabase_properties_typeProperties_server="asa-nprd-sql.database.windows.net" AzureSqlDatabase_properties_typeProperties_database="AdventureWorksDB" containerUri="${{ env.GITHUB_CONTAINER_URI }}/linkedTemplates" containerSasToken="?token=${{ env.GITHUB_RAW_TOKEN }}"
    #       deploymentMode: Incremental
    #       # additionalArguments: "--what-if --rollback-on-error" # --what-if-exclude-change-types Create Ignore"

      - name: Deploy ARM template with AZ CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |

          cd ./linkedTemplates
          az deployment group create --name "adf-deployment-${{ github.run_id }}" --resource-group ${{ vars.ADF_RESOURCE_GROUP }} --template-file ArmTemplate_master.json --parameters @ArmTemplateParameters_master.json --parameters containerUri="${{ env.GITHUB_CONTAINER_URI }}linkedTemplates" containerSasToken="&token=${{ env.GH_TOKEN }}"
